syntax = "proto3";

package search.v1;

option go_package = "github.com/visionworld/search-service/proto/search/v1;search_v1";

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";

// 搜索服务定义
service SearchService {
  // 搜索视频
  rpc SearchVideos(SearchVideosRequest) returns (SearchVideosResponse);
  
  // 搜索用户
  rpc SearchUsers(SearchUsersRequest) returns (SearchUsersResponse);
  
  // 获取搜索建议
  rpc GetSearchSuggestions(GetSearchSuggestionsRequest) returns (GetSearchSuggestionsResponse);
  
  // 获取热门搜索词
  rpc GetHotKeywords(GetHotKeywordsRequest) returns (GetHotKeywordsResponse);
  
  // 记录搜索行为
  rpc RecordSearchBehavior(RecordSearchBehaviorRequest) returns (google.protobuf.Empty);
  
  // 创建搜索索引
  rpc CreateSearchIndex(CreateSearchIndexRequest) returns (CreateSearchIndexResponse);
  
  // 更新搜索索引
  rpc UpdateSearchIndex(UpdateSearchIndexRequest) returns (UpdateSearchIndexResponse);
  
  // 删除搜索索引
  rpc DeleteSearchIndex(DeleteSearchIndexRequest) returns (google.protobuf.Empty);
  
  // 获取搜索统计
  rpc GetSearchStats(GetSearchStatsRequest) returns (GetSearchStatsResponse);
  
  // 获取搜索历史
  rpc GetSearchHistory(GetSearchHistoryRequest) returns (GetSearchHistoryResponse);
  
  // 清除搜索历史
  rpc ClearSearchHistory(ClearSearchHistoryRequest) returns (google.protobuf.Empty);
}

// 搜索类型枚举
enum SearchType {
  SEARCH_TYPE_UNSPECIFIED = 0;
  SEARCH_TYPE_VIDEO = 1;        // 视频搜索
  SEARCH_TYPE_USER = 2;           // 用户搜索
  SEARCH_TYPE_TAG = 3;            // 标签搜索
  SEARCH_TYPE_CATEGORY = 4;       // 分类搜索
}

// 搜索排序类型枚举
enum SearchSortType {
  SEARCH_SORT_UNSPECIFIED = 0;
  SEARCH_SORT_RELEVANCE = 1;      // 相关度
  SEARCH_SORT_LATEST = 2;         // 最新
  SEARCH_SORT_HOTTEST = 3;        // 最热
  SEARCH_SORT_MOST_VIEWED = 4;    // 最多观看
  SEARCH_SORT_MOST_LIKED = 5;     // 最多点赞
}

// 索引类型枚举
enum IndexType {
  INDEX_TYPE_UNSPECIFIED = 0;
  INDEX_TYPE_VIDEO = 1;           // 视频索引
  INDEX_TYPE_USER = 2;            // 用户索引
  INDEX_TYPE_TAG = 3;             // 标签索引
}

// 搜索文档
message SearchDocument {
  string id = 1;
  IndexType type = 2;
  map<string, string> fields = 3;     // 文档字段
  map<string, float> boost_fields = 4;  // 权重字段
  google.protobuf.Timestamp created_at = 5;
  google.protobuf.Timestamp updated_at = 6;
}

// 搜索结果项
message SearchResult {
  string id = 1;
  IndexType type = 2;
  double score = 3;                    // 搜索得分
  map<string, string> highlight = 4;   // 高亮字段
  map<string, string> source = 5;        // 原始数据
}

// 搜索建议项
message SuggestionItem {
  string text = 1;
  string type = 2;                       // 类型：keyword, user, tag, category
  int32 frequency = 3;                   // 出现频率
  double score = 4;                      // 建议得分
}

// 热门关键词
message HotKeyword {
  string keyword = 1;
  int32 search_count = 2;                // 搜索次数
  double trend_score = 3;                // 趋势分数
  google.protobuf.Timestamp last_searched = 4;
  int32 rank = 5;                        // 排名
}

// 搜索行为记录
message SearchBehavior {
  string user_id = 1;
  string keyword = 2;
  SearchType search_type = 3;
  int32 result_count = 4;                // 结果数量
  bool has_click = 5;                    // 是否点击结果
  string clicked_result = 6;             // 点击的结果ID
  google.protobuf.Timestamp search_time = 7;
  string ip_address = 8;
  string device_id = 9;
  map<string, string> context = 10;       // 上下文信息
}

// 搜索统计信息
message SearchStats {
  int32 total_searches = 1;              // 总搜索次数
  int32 unique_users = 2;                // 独立用户数
  double avg_results_per_search = 3;       // 平均结果数
  double click_through_rate = 4;         // 点击率
  repeated HotKeyword top_keywords = 5;   // 热门关键词
  map<string, int32> search_type_stats = 6; // 搜索类型统计
}

// 搜索历史记录
message SearchHistory {
  string keyword = 1;
  SearchType search_type = 2;
  google.protobuf.Timestamp search_time = 3;
  int32 result_count = 4;
  bool has_click = 5;
}

// 搜索视频请求
message SearchVideosRequest {
  string keyword = 1;
  int32 page = 2;
  int32 page_size = 3;
  SearchSortType sort_by = 4;
  string category_id = 5;                // 分类筛选
  repeated string tags = 6;              // 标签筛选
  string user_id = 7;                    // 用户ID（用于个性化）
  int32 min_duration = 8;                // 最小时长（秒）
  int32 max_duration = 9;                // 最大时长（秒）
  string publish_time_range = 10;        // 发布时间范围：day, week, month, year
  bool enable_highlight = 11;            // 是否启用高亮
}

// 搜索视频响应
message SearchVideosResponse {
  repeated SearchResult results = 1;
  int32 total = 2;
  int32 took = 3;                        // 搜索耗时（毫秒）
  repeated SuggestionItem suggestions = 4; // 搜索建议
  map<string, string> aggregations = 5;    // 聚合统计
}

// 搜索用户请求
message SearchUsersRequest {
  string keyword = 1;
  int32 page = 2;
  int32 page_size = 3;
  SearchSortType sort_by = 4;
  bool enable_highlight = 5;
}

// 搜索用户响应
message SearchUsersResponse {
  repeated SearchResult results = 1;
  int32 total = 2;
  int32 took = 3;
  repeated SuggestionItem suggestions = 4;
}

// 获取搜索建议请求
message GetSearchSuggestionsRequest {
  string keyword = 1;
  SearchType search_type = 2;
  int32 limit = 3;
  string user_id = 4;                    // 用户ID（用于个性化建议）
}

// 获取搜索建议响应
message GetSearchSuggestionsResponse {
  repeated SuggestionItem suggestions = 1;
  int32 took = 2;
}

// 获取热门搜索词请求
message GetHotKeywordsRequest {
  SearchType search_type = 1;
  int32 limit = 2;
  string time_range = 3;                 // 时间范围：day, week, month
  string category = 4;                    // 分类
}

// 获取热门搜索词响应
message GetHotKeywordsResponse {
  repeated HotKeyword hot_keywords = 1;
  google.protobuf.Timestamp generated_at = 2;
}

// 记录搜索行为请求
message RecordSearchBehaviorRequest {
  SearchBehavior behavior = 1;
}

// 创建搜索索引请求
message CreateSearchIndexRequest {
  string index_name = 1;
  IndexType index_type = 2;
  map<string, string> mappings = 3;      // 字段映射
  map<string, string> settings = 4;        // 索引设置
}

// 创建搜索索引响应
message CreateSearchIndexResponse {
  string index_name = 1;
  bool success = 2;
  string message = 3;
}

// 更新搜索索引请求
message UpdateSearchIndexRequest {
  string index_name = 1;
  SearchDocument document = 2;
}

// 更新搜索索引响应
message UpdateSearchIndexResponse {
  string document_id = 1;
  bool success = 2;
  string message = 3;
}

// 删除搜索索引请求
message DeleteSearchIndexRequest {
  string index_name = 1;
  string document_id = 2;
}

// 获取搜索统计请求
message GetSearchStatsRequest {
  string start_date = 1;                 // 开始日期（YYYY-MM-DD）
  string end_date = 2;                   // 结束日期（YYYY-MM-DD）
  SearchType search_type = 3;
}

// 获取搜索统计响应
message GetSearchStatsResponse {
  SearchStats stats = 1;
  google.protobuf.Timestamp generated_at = 2;
}

// 获取搜索历史请求
message GetSearchHistoryRequest {
  string user_id = 1;
  int32 limit = 2;
  SearchType search_type = 3;
}

// 获取搜索历史响应
message GetSearchHistoryResponse {
  repeated SearchHistory history = 1;
  google.protobuf.Timestamp generated_at = 2;
}

// 清除搜索历史请求
message ClearSearchHistoryRequest {
  string user_id = 1;
  SearchType search_type = 2;
}